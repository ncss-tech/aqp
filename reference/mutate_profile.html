<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en-US"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Transform a SPC (by profile) with a set of expressions — mutate_profile • aqp</title><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Transform a SPC (by profile) with a set of expressions — mutate_profile"><meta name="description" content="mutate_profile() is a function used for transforming SoilProfileCollections. Each expression is applied to site or horizon level attributes of individual profiles. This distinguishes this function from transform, which is applied to all values in a collection, regardless of which profile they came from."><meta property="og:description" content="mutate_profile() is a function used for transforming SoilProfileCollections. Each expression is applied to site or horizon level attributes of individual profiles. This distinguishes this function from transform, which is applied to all values in a collection, regardless of which profile they came from."></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">aqp</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">2.2-1</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="active nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles"><li><a class="dropdown-item" href="../articles/aqp-overview.html">An Overview of the aqp Package</a></li>
    <li><a class="dropdown-item" href="../articles/Introduction-to-SoilProfileCollection-Objects.html">Introduction to SoilProfileCollection Objects</a></li>
    <li><a class="dropdown-item" href="../articles/label-placement.html">Overlapping Annotation</a></li>
    <li><a class="dropdown-item" href="../articles/missing-data.html">Missing Data</a></li>
    <li><a class="dropdown-item" href="../articles/Munsell-color-conversion.html">Munsell Color Conversion</a></li>
    <li><a class="dropdown-item" href="../articles/NCSP.html">Numerical Classification of Soil Profiles</a></li>
    <li><a class="dropdown-item" href="../articles/new-in-aqp-2.html">What is new in aqp 2.x?</a></li>
  </ul></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json"></form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/ncss-tech/aqp/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul></div>


  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Transform a SPC (by profile) with a set of expressions</h1>
      <small class="dont-index">Source: <a href="https://github.com/ncss-tech/aqp/blob/master/R/mutate_profile.R" class="external-link"><code>R/mutate_profile.R</code></a></small>
      <div class="d-none name"><code>mutate_profile.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p><code>mutate_profile()</code> is a function used for transforming SoilProfileCollections. Each expression is applied to site or horizon level attributes of individual profiles. This distinguishes this function from <code>transform</code>, which is applied to all values in a collection, regardless of which profile they came from.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">mutate_profile</span><span class="op">(</span><span class="va">object</span>, <span class="va">...</span>, col_names <span class="op">=</span> <span class="cn">NULL</span>, horizon_level <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">mutate_profile_raw</span><span class="op">(</span><span class="va">object</span>, <span class="va">expr</span>, col_names <span class="op">=</span> <span class="cn">NULL</span>, horizon_level <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>


<dl><dt id="arg-object">object<a class="anchor" aria-label="anchor" href="#arg-object"></a></dt>
<dd><p>A SoilProfileCollection</p></dd>


<dt id="arg--">...<a class="anchor" aria-label="anchor" href="#arg--"></a></dt>
<dd><p>A set of comma-delimited R expressions that resolve to a transformation to be applied to a single profile e.g <code>mutate_profile(hzdept = max(hzdept) - hzdept)</code></p></dd>


<dt id="arg-col-names">col_names<a class="anchor" aria-label="anchor" href="#arg-col-names"></a></dt>
<dd><p>character. Optional column names. Should match the number of expressions in <code>...</code>.</p></dd>


<dt id="arg-horizon-level">horizon_level<a class="anchor" aria-label="anchor" href="#arg-horizon-level"></a></dt>
<dd><p>logical. If <code>TRUE</code> results of expressions are added to the SoilProfileCollection's horizon slot, if <code>FALSE</code> the results are added to the site slot. If <code>NULL</code> (default) the results are stored in the site or horizon slot based on the number of rows in each slot compared to the length of the result calculated from the <em>first</em> and <em>last</em> profile in the collection.</p></dd>


<dt id="arg-expr">expr<a class="anchor" aria-label="anchor" href="#arg-expr"></a></dt>
<dd><p>A list of expressions in terms of column names in site or horizon table of <code>object</code></p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    <p>A SoilProfileCollection.</p>
    </div>
    <div class="section level2">
    <h2 id="details">Details<a class="anchor" aria-label="anchor" href="#details"></a></h2>
    <p>If the length an expression's result matches the number of horizons, the result is stored as a horizon-level variable. If the result has length 1, it is stored as a site-level variable. In the ambiguous case where the first and last profile have only <em>one</em> horizon, the results are stored in the horizon slot by default. To force results into site slot use <code>horizon_level = FALSE</code>.</p>
    </div>
    <div class="section level2">
    <h2 id="author">Author<a class="anchor" aria-label="anchor" href="#author"></a></h2>
    <p>Andrew G. Brown.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">sp4</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="depths.html">depths</a></span><span class="op">(</span><span class="va">sp4</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">id</span> <span class="op">~</span> <span class="va">top</span> <span class="op">+</span> <span class="va">bottom</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="fu">mutate_profile</span><span class="op">(</span><span class="va">sp4</span>, clay_wtd_average <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/weighted.mean.html" class="external-link">weighted.mean</a></span><span class="op">(</span><span class="va">clay</span>, <span class="va">bottom</span> <span class="op">-</span> <span class="va">top</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> SoilProfileCollection with 10 profiles and 30 horizons</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> profile ID: id  |  horizon ID: hzID </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Depth range: 16 - 49 cm</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> ----- Horizons (6 / 30 rows  |  10 / 14 columns) -----</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>      id hzID top bottom name   K   Mg  Ca CEC_7 ex_Ca_to_Mg</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  colusa    1   0      3    A 0.3 25.7 9.0  23.0        0.35</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  colusa    2   3      8  ABt 0.2 23.7 5.6  21.4        0.23</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  colusa    3   8     30  Bt1 0.1 23.2 1.9  23.7        0.08</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  colusa    4  30     42  Bt2 0.1 44.3 0.3  43.0        0.01</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   glenn    5   0      9    A 0.2 21.9 4.4  18.8        0.20</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   glenn    6   9     34   Bt 0.3 18.9 4.5  27.5        0.20</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [... more horizons ...]</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> ----- Sites (6 / 10 rows  |  2 / 2 columns) -----</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         id clay_wtd_average</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     colusa         37.19048</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>      glenn         31.61765</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>      kings         21.90000</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   mariposa         30.32653</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  mendocino         21.93333</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>       napa         16.40000</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [... more sites ...]</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Spatial Data:</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [EMPTY]</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">jacobs2000</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">## col_names allows for column names to be calculated</span></span></span>
<span class="r-in"><span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu">mutate_profile</span><span class="op">(</span><span class="va">jacobs2000</span>, <span class="va">bottom</span> <span class="op">-</span> <span class="va">top</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">bottom</span> <span class="op">-</span> <span class="va">top</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>                    col_names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"relthk"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">floor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">100</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">x</span><span class="op">$</span><span class="va">relthk28</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [1]  18.00000  42.91549  78.79812 129.62911 152.38967 155.28169 212.26761</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [8]  18.00000  45.91549  83.78404 121.60563 144.42723 212.31925  15.00000</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [15]  24.91429  63.85714  83.63429 111.52000 164.36000 174.05714  20.00000</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [22]  52.90148  78.73892 129.61084 164.35961 184.18719 202.08867  28.00000</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [29]  60.84699 108.66667 134.40437 182.26230  18.00000  45.89286  75.72619</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [36] 103.54762 118.38095 167.29167  15.00000  40.90132  47.73026  60.68421</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [43]  90.59868 131.40132 139.13158 151.07895</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># mutate_profile_raw allows for lists of expressions to be evaluated</span></span></span>
<span class="r-in"><span><span class="va">master_desgn</span> <span class="op">&lt;-</span> <span class="fu"><a href="combine-SoilProfileCollection-method.html">c</a></span><span class="op">(</span><span class="st">"O"</span>, <span class="st">"A"</span>, <span class="st">"E"</span>, <span class="st">"B"</span>, <span class="st">"C"</span>, <span class="st">"R"</span>, <span class="st">"L"</span>, <span class="st">"M"</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">thk_names</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"thk_"</span>, <span class="va">master_desgn</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># calculate thickness for each horizon</span></span></span>
<span class="r-in"><span><span class="va">x</span><span class="op">$</span><span class="va">thk</span> <span class="op">&lt;-</span> <span class="va">x</span><span class="op">$</span><span class="va">bottom</span> <span class="op">-</span> <span class="va">x</span><span class="op">$</span><span class="va">top</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">## construct an arbitrary number of expressions using variable inputs</span></span></span>
<span class="r-in"><span><span class="va">ops</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">master_desgn</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="https://rdrr.io/r/base/substitute.html" class="external-link">substitute</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">thk</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grepl</a></span><span class="op">(</span><span class="va">PATTERN</span>, <span class="va">name</span><span class="op">)</span><span class="op">]</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>PATTERN <span class="op">=</span> <span class="va">x</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">}</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="names.html">names</a></span><span class="op">(</span><span class="va">ops</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">thk_names</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># do mutation</span></span></span>
<span class="r-in"><span><span class="va">y</span> <span class="op">&lt;-</span> <span class="fu">mutate_profile_raw</span><span class="op">(</span><span class="va">x</span>, <span class="va">ops</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="fu"><a href="site.html">site</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="combine-SoilProfileCollection-method.html">c</a></span><span class="op">(</span><span class="fu"><a href="idname.html">idname</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span>, <span class="va">thk_names</span><span class="op">)</span><span class="op">]</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     id thk_O thk_A thk_E thk_B thk_C thk_R thk_L thk_M</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 1 92-1     0    18    25   113    60     0     0     0</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 2 92-2     0    18    28    99    68     0     0     0</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 3 92-3     0    25    49   111     0     0     0     0</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 4 92-4     0    20     0     0   183     0     0     0</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 5 92-5     0    28    81    26    48     0     0     0</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 6 92-6     0    46    86    64     0     0     0     0</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 7 92-7     0    15    97    28    12     0     0     0</span>
</code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Dylan Beaudette, Pierre Roudier, Andrew Brown, Stephen Roecker.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer></div>





  </body></html>

